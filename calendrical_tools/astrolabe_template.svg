<svg id="top" viewbox="0 0 250 250" height="250" width="250" xmlns="http://www.w3.org/2000/svg" 
	xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" xmlns:xlink="http://www.w3.org/1999/xlink"
	onload="init(evt)">
	<g id="astrolabe" transform="translate(125,125)" {{ inkscape.astrolabe }}>
	    <title>Astrolabe Plate</title>
	    <defs>
			<style type="text/css">
				#plate {
				  clip-path:url(#Capricorn);
				  clipPath: url(#Capricorn);
				}
				#description {
				  fill: {{ background_color }}
				  text-anchor: middle;
				  font-size: 6pt;
				}
				#horizon {
				  fill: none;
				  stroke: {{ background_color }}
				  stroke-width: 1;
				}
				#tropics {
				  fill: none;
				  stroke: {{ background_color }}
				  stroke-width: 1;
				  stroke-opacity: 0.5;
				  clip-path: url(#almucantarHole);
				}
				#almucantar {
				  fill: none;
				  stroke: {{ graph_color }}
				  stroke-width: 0.5;
				}
				#azimuth {
				  fill: none;
				  stroke: {{ graph_color }}
				  stroke-width: 0.5;
				  clip-path:url(#Horizon);
				  clipPath: url(#Horizon);
				}
				#azimuths{
				  clip-path: url(#almucantarHole);
				}
				#primeVertical {
				  fill: none;
				  stroke: {{ graph_color }}
				  stroke-width: 0.75;
				  clip-path:url(#Horizon);
				  clipPath: url(#Horizon);
				}
				#axis {
				  fill: none;
				  stroke: {{ background_color }}
				  stroke-width: 1;
				  stroke-opacity: 0.5;
				  clip-path: url(#descriptionHole);
				}
				#tick {
				  stroke: {{ background_color }}
				  stroke-width: 0.5;
				}
				#tickLong {
				  stroke: {{ background_color }}
				  stroke-width: 1;
				}
				#ecliptic {
				  fill: {{ stroke_color }}
				  fill-opacity: 1;
				  stroke: {{ stroke_color }}
				  stroke-width: 0.7;
				  stroke-opacity: 0.7;
				  clip-path: url(#eclipticHole);
				}
				#eclipticDivision {
				  stroke: black;
				  stroke-width: 0.5;
				  stroke-opacity: 0.2;
				}
				#limb {
				  fill: none;
				  stroke: {{ background_color }}
				  stroke-opacity: 0.5;
				  stroke-width: 1;
				}
			</style>

			<clipPath id="Capricorn">
				<path d="
						M0 {{ RCapricorn }}
						A{{ RCapricorn }} {{ RCapricorn }} 0 0 1 0 {{ -RCapricorn }}
						A{{ RCapricorn }} {{ RCapricorn }} 0 0 1 0 {{ RCapricorn }}z"
					/>		
			</clipPath>			

			<clipPath id="Horizon">
				<path d="
						M{{ horiz.cx }} {{ horiz.cy + horiz.r }} 
						A{{ horiz.r }} {{ horiz.r }} 0 0 1 {{ horiz.cx }} {{ horiz.cy - horiz.r }}
						A{{ horiz.r }} {{ horiz.r }} 0 0 1 {{ horiz.cx }} {{ horiz.cy + horiz.r }}z
					"/>
			</clipPath>

		    <clipPath id="almucantarHole">
				<path fill-rule="evenodd"  d="
					M{{ 0 }} {{ RCapricorn }} 
					A{{ RCapricorn }} {{ RCapricorn }} 0 0 1 {{ 0 }} {{ -RCapricorn }}
					A{{ RCapricorn }} {{ RCapricorn }} 0 0 1 {{ 0 }} {{ RCapricorn }}z
					M{{ almucantar_center.cx }} {{ almucantar_center.cy + almucantar_center.r}} 
					A{{ almucantar_center.r }} {{ almucantar_center.r }} 0 1 0 {{ almucantar_center.cx }} {{ almucantar_center.cy - almucantar_center.r }}
					A{{ almucantar_center.r }} {{ almucantar_center.r }} 0 1 0 {{ almucantar_center.cx }} {{ almucantar_center.cy + almucantar_center.r }}z
				"/>
		    </clipPath>

		    <clipPath id="descriptionHole" >
		    	<!-- <rect id="description" x="-10" y="{{ RCapricorn - 20 -7}}" width="20" height="19"/> -->
		    	<path id="test" fill-rule="evenodd" transform="rotate(180)" d="
		    		M{{ 0 }} {{ RCapricorn }} 
					A{{ RCapricorn }} {{ RCapricorn }} 0 1 0 {{ 0 }} {{ -RCapricorn }}
					A{{ RCapricorn }} {{ RCapricorn }} 0 1 0 {{ 0 }} {{ RCapricorn }}z
		    		M-10,{{ RCapricorn - 20 - 7 }} 10,{{ RCapricorn - 20 - 7 }} 10,{{ RCapricorn - 20 - 7 + 19 }} -10,{{ RCapricorn -20 -7 + 19 }} -10,{{ RCapricorn - 20 - 7 }} 0,{{ RCapricorn }}

		    	"/>
		    </clipPath>

		    <clipPath id="eclipticBoundary">
		    	<path id="eclipticArc" fill-rule="evenodd" d="
					M{{ top_middle_outer.x }} {{ top_middle_outer.y }}
					A{{ outer_radius }} {{ outer_radius }} 0 1 0 {{ bottom_middle_outer.x }} {{ bottom_middle_outer.y }}
					A{{ outer_radius }} {{ outer_radius }} 0 1 0 {{ top_middle_outer.x }} {{ top_middle_outer.y }}z"/>
		    </clipPath>

		    <clipPath id="eclipticHole">
		    	<path fill-rule="evenodd" d="
					M{{ top_middle_outer.x }} {{ top_middle_outer.y }}
					A{{ outer_radius }} {{ outer_radius }} 0 0 1 {{ bottom_middle_outer.x }} {{ bottom_middle_outer.y }}
					A{{ outer_radius }} {{ outer_radius }} 0 0 1 {{ top_middle_outer.x }} {{ top_middle_outer.y }}z
					M{{ top_middle_inner.x }} {{ top_middle_inner.y }}
					A{{ inner_radius }} {{ inner_radius }} 0 1 0 {{ bottom_middle_inner.x }} {{ bottom_middle_inner.y }}
					A{{ inner_radius }} {{ inner_radius }} 0 1 0 {{top_middle_inner.x }} {{ top_middle_inner.y }}z"/>
		    </clipPath>

		{% for arc in seasonal_arcs %}
			<path id="{{ arc.tag }}" d="
				M{{ arc.start_x }} {{ arc.start_y }}
				A{{ arc.r }} {{ arc.r }} 0 0 1 {{ arc.end_x }} {{ arc.end_y }}
				A{{ arc.r }} {{ arc.r }} 0 0 1 {{ arc.start_x }} {{ arc.start_y }}"/>
		{%- endfor %}

		</defs>

		<g id="plate" transform="rotate(180)" {{ inkscape.plate }}>
			<g id="tropics" {{ inkscape.tropics }}>
				<circle cx="0" cy="0" r="{{ RCapricorn }}"/>
				<circle cx="0" cy="0" r="{{ REquator }}"/>
				<circle cx="0" cy="0" r="{{ RCancer }}"/>
			</g>

			<g id="horizon" {{ inkscape.horizon }}>
		        <title>Horizon</title>
		        <circle cx="{{ horiz.cx}}" cy="{{ horiz.cy }}" r="{{ horiz.r }}"/>
	      	</g>

			<g id="azimuths" {{ inkscape.azimuths }}>
				<title>Azimuth</title>
				{% for coord in azimuth_coords %}
					<circle id="azimuth" az="{{ coord.az }}" cx="{{ coord.cx }}" cy="{{ coord.cy }}" r="{{ coord.r }}"/>
				{%- endfor %}			
		    </g>

			<g id="almucantars" {{ inkscape.almucantars }}>
				<title>Almucantar</title>
				{% for coord in almucantor_coords %}
					<circle id="almucantar" alt="{{ coord.alt }}" cx="{{ coord.cx }}" cy="{{ coord.cy }}" r="{{ coord.r }}"/>
				{%- endfor %}
			</g>

			<g id="primeVertical" {{ inkscape.prime_vertical }}>
				<circle id="primeVertical" cx="{{ prime_vertical.cx }}" cy="{{ prime_vertical.cy }}" r="{{ prime_vertical.r }}"/>
			</g>

			<g id="axis" {{ inkscape.axis }}>
	      		<line id="axis" x1="0" y1="{{ -RCapricorn }}" x2="0" y2="{{ RCapricorn }}"/>
        		<line id="axis" x1="{{ -RCapricorn }}" y1="0" x2="{{ RCapricorn }}" y2="0"/>
    		</g>

    		<g {{ inkscape.description }} transform="rotate(180)">
				<text id="description" x="0" y="{{ RCapricorn - 20 }}">
					{{ place_name }}
		    		<tspan x="0" dy="1.2em">{{ latitude }} </tspan>
		    	</text>
			</g>
	    </g>

		<g id="limb" {{ inkscape.limb }}>
			<title>Limb</title>

			<text id="output" x="0" y="110" style="font-size:4pt; fill:black; stroke:none;" text-anchor="middle"></text>

			<g id="limb_boundaries" {{ inkscape.limb_boundaries }}>
				<circle id="limb" cx="0" cy="0" r="{{ ticks.inner_radius }}"/>
				<circle id="limb" cx="0" cy="0" r="{{ ticks.center_radius }}"/>
				<circle id="limb" cx="0" cy="0" r="{{ ticks.outer_radius }}"/>
			</g>
			<g id="ticks" {{ inkscape.ticks }}>
				<g id="short_ticks" {{ inkscape.short_ticks }}>
					<line id="tick" x1="0" y1="{{ ticks.inner_radius }}" x2="0" y2="{{ ticks.center_radius }}"/>
					{% for angle in ticks.short_tick_angles %}
				    	<use id="tick" xlink:href="#tick" transform="rotate({{ angle }})"/>
					{%- endfor %}
				</g>
				<g id="long_ticks" {{ inkscape.long_ticks }}>
				    <line id="tickLong" x1="0" y1="{{ ticks.inner_radius }}" x2="0" y2="{{ ticks.outer_radius }}"/>
					{% for angle in ticks.long_tick_angles %}
				    	<use id="tickLong" xlink:href="#tickLong" transform="rotate({{ angle }})"/>
					{%- endfor %}
				</g>
		    </g>
		</g>

		<g id = "rete" {{ inkscape.rete }} transform="rotate(180)">
			<g id="ecliptic" {{ inkscape.ecliptic }}>
		    	<title>Ecliptic</title>
				<path id="ecliptic" fill-rule="evenodd" d="
					M{{ top_middle_outer.x }} {{ top_middle_outer.y }}
					A{{ outer_radius }} {{ outer_radius }} 0 0 1 {{ bottom_middle_outer.x }} {{ bottom_middle_outer.y }}
					A{{ outer_radius }} {{ outer_radius }} 0 0 1 {{ top_middle_outer.x }} {{ top_middle_outer.y }}z
					M{{ top_middle_inner.x }} {{ top_middle_inner.y }}
					A{{ inner_radius }} {{ inner_radius }} 0 0 1 {{ bottom_middle_inner.x }} {{ bottom_middle_inner.y }}
					A{{ inner_radius }} {{ inner_radius }} 0 0 1 {{top_middle_inner.x }} {{ top_middle_inner.y }}z"/>

				<!-- <line  x1="0" y1="300" x2="0" y2="-300" style="stroke: black;"/> -->
			    <g>
			        <title>Divide Ecliptic</title>
			        
			        {% for division in ecliptic_divisions %}
			            <line id="eclipticDivision" x1="0" y1="0" x2="{{ division.x2 }}" y2="{{ division.y2 }}"/>
			        {%- endfor %}
			    </g>
			    
			    {% for arc in seasonal_arcs %}
					<text><textPath xlink:href="#{{ arc.tag }}" style="fill:black;font-size:3pt;" startOffset="5em"><tspan dy="1em">{{ arc.name }}</tspan></textPath></text>
				{%- endfor %}
  			</g>

  			<g>
  				<line id="eclipticPole" x1="-5" y1="{{ ecliptic_center }}" x2="5" y2="{{ ecliptic_center }}" style="stroke: grey;"/>
				<line id="eclipticPole" x1="0" y1="{{ ecliptic_center -5 }}" x2="0" y2="{{ ecliptic_center + 5 }}" style="stroke: grey;"/>
  			</g>

		        <!-- <line id="eclipticDivision" x1="0" y1="0" x2="65.63970574410436" y2="0"/> -->
		        
		 	<g id="stars" {{ inkscape.stars }}>
		    	<title>Stars</title>
		    </g>

		    <g id="planets" {{ inkscape.planets }} transform="translate({{ ecliptic.cx }}, {{ ecliptic.cy }})">
		    	<title>Planets</title>
		    	<line id="moonLine" x1="0" y1="0" x2="0" y2="100" style="stroke:black;"/>
		    	<circle id="moon" cx="78.3193942774644" cy="60.97340898963562" r="3" style="fill:white; stroke:black;" />
		    </g>
		</g>
		
	</g>
	<script type="application/ecmascript">
    // <![CDATA[
    var txt = document.getElementById("output");
    var r = document.getElementById("moonLine");
    
    function init(evt) {
        var obj;
        obj = document.getElementById("top");
        obj.addEventListener("click", clickButton, false);
        obj.addEventListener("mousedown", startDrag, false);
        obj.addEventListener("mousemove", doDrag, false);
    }
    
    function angle(cx, cy, ex, ey) {
      var dy = ey - cy;
      var dx = ex - cx;
      var theta = Math.atan2(dy, dx); // range (-PI, PI]
      theta *= 180 / Math.PI; // rads to degs, range (-180, 180]
      //if (theta < 0) theta = 360 + theta; // range [0, 360)
      return theta;
    }
    
    function clickButton(evt) {
        var msg = r.getAttribute("x2") + ", " +
        r.getAttribute("y2") + ", " +
        r.style.getPropertyValue("stroke") + " " +
        r.style.getPropertyValue("fill") + " " +
        angle(0, 0, r.getAttribute("x2"), r.getAttribute("y2"));
        r.setAttribute("height", "30");
        printMsg(msg); 
    }
    
    function startDrag(evt) {
        <!-- var sliderId = evt.target.parentNode.getAttribute("id"); -->
        var svg = document.getElementById('top');
        var pt = svg.createSVGPoint();
        
        pt.x = evt.clientX; 
        pt.y = evt.clientY;
        
        var ec = document.getElementById('axis');
        
        var svgP = pt.matrixTransform(ec.getScreenCTM().inverse());
        
        printMsg(pt.x + " " + pt.y + " | " + svgP.x + " " + svgP.y + " | " + angle(0, 0, svgP.x, svgP.y));
    }
    
    function doDrag(evt) {
        var ec = document.getElementById('axis'); 
        var rete = document.getElementById('rete');
        var svg = document.getElementById('top');

        var pt = svg.createSVGPoint(); 
        pt.x = evt.clientX; 
        pt.y = evt.clientY;
        
        var svgP = pt.matrixTransform(ec.getScreenCTM().inverse());
        var rotAngle = angle(0, 0, svgP.x, svgP.y)
        
        printMsg(pt.x + " " + pt.y + " | " + svgP.x + " " + svgP.y + " | " + rotAngle);
        rete.setAttribute("transform", "rotate(" + rotAngle + ")");
    }
    
    function printMsg (msg){
        txt.textContent=msg;    
    }
    // ]]>
</script>
</svg>
